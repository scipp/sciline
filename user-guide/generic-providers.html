
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Generic Providers &#8212; Sciline</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=0d8463a1"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user-guide/generic-providers';</script>
    <script src="../_static/anaconda-icon.js?v=461bdc62"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Provenance" href="provenance.html" />
    <link rel="prev" title="Parameter Tables" href="parameter-tables.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="25.11.1" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.svg" class="logo__image only-light" alt="Sciline - Home"/>
    <img src="../_static/logo-dark.svg" class="logo__image only-dark pst-js-only" alt="Sciline - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../recipes/index.html">
    Recipes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api-reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../developer/index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    About
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io/cyclebane">
    Cyclebane
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://scipp.github.io">
    Scipp
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/scipp/sciline" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/sciline/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://anaconda.org/conda-forge/sciline" title="Conda" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-anaconda fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Conda</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../recipes/index.html">
    Recipes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api-reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../developer/index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../about/index.html">
    About
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io/cyclebane">
    Cyclebane
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://scipp.github.io">
    Scipp
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/scipp/sciline" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/sciline/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://anaconda.org/conda-forge/sciline" title="Conda" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-anaconda fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Conda</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="parameter-tables.html">Parameter Tables</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Generic Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="provenance.html">Provenance</a></li>
</ul>
</div>
</nav></div>
        <div class="sidebar-primary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Counter-example:-Naive-approach">Counter example: Naive approach</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Generic-domain-types-and-providers">Generic domain types and providers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Advantages-of-using-generic-providers">Advantages of using generic providers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Computing-intermediate-results">Computing intermediate results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Specialized-providers">Specialized providers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Generic-providers-and-map-operations">Generic providers and map operations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Constraining-type-vars-in-a-pipeline">Constraining type vars in a pipeline</a></li>
</ul>
</li>
</ul>
  </nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/user-guide/generic-providers.ipynb"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Generic Providers</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="Generic-Providers">
<h1>Generic Providers<a class="headerlink" href="#Generic-Providers" title="Link to this heading">#</a></h1>
<section id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Link to this heading">#</a></h2>
<p>Sometimes we may want to replicate parts of a workflow and apply it to a different input. In <a class="reference internal" href="parameter-tables.html"><span class="doc">Parameter Tables</span></a> we saw how we can use a parameter table for this purpose. Another approach is to use <a class="reference external" href="https://mypy.readthedocs.io/en/stable/generics.html">generics</a> to define a generic provider.</p>
<p>While parameter tables are well suited for “homogeneous” tasks such as a set of images, generics can be a better choice for “heterogeneous” tasks where the computation steps are (nearly) identical, but the purpose of the computation is different. For example, we may have a “data” image and a “background” image (from a sensor background measurement). We want to perform some initial homogeneous operations on both, but ultimately reach a point where we want to subtract the background from the data.</p>
<p>Generally speaking, using Sciline with generics can have several advantages:</p>
<ul class="simple">
<li><p>Intuitive syntax for requesting computation of intermediate results.</p></li>
<li><p>Specialized providers for intermediate steps can be used instead of the necessarily identical providers when working with parameter tables.</p></li>
<li><p>Maintain reusability of providers and avoid synchronization points in workflows by combining parameter tables and generic providers.</p></li>
</ul>
<p>Before moving on to the next sections where we will elaborate on these points, consider how generic providers can be used straightforwardly in a pipeline. For example, we can setup a pipeline computing a list of any type (provided that there is a parameter of the type) in a very compact manner:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeVar</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sciline</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">duplicate</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A generic provider that can make any list.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>


<span class="n">pipeline</span> <span class="o">=</span> <span class="n">sciline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">([</span><span class="n">duplicate</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="nb">int</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span> <span class="nb">str</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1, 1]
[2.0, 2.0]
[&#39;3&#39;, &#39;3&#39;]
</pre></div></div>
</div>
</section>
<section id="Counter-example:-Naive-approach">
<h2>Counter example: Naive approach<a class="headerlink" href="#Counter-example:-Naive-approach" title="Link to this heading">#</a></h2>
<p>Starting with the model workflow introduced in <a class="reference internal" href="getting-started.html"><span class="doc">Getting Started</span></a>, consider an extension where we also need to subtract a background signal from the data. Naively, we could extend the example as follows, which is very verbose and error prone due to the duplication:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NewType</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sciline</span>

<span class="n">_fake_filesytem</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;file102.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">],</span>
    <span class="s1">&#39;file103.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="s1">&#39;file104.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;file105.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="s1">&#39;background.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">}</span>

<span class="c1"># 1. Define domain types</span>

<span class="n">Filename</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;Filename&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="n">BackgroundFilename</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;BackgroundFilename&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="n">RawData</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;RawData&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
<span class="n">RawBackground</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;RawBackground&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
<span class="n">CleanedData</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;CleanedData&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="n">CleanedBackground</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;CleanedBackground&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="n">ScaleFactor</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;ScaleFactor&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">Background</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;Background&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="n">BackgroundSubtractedData</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;BackgroundSubtractedData&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="n">Result</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;Result&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>


<span class="c1"># 2. Define providers</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">_fake_filesytem</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">}}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="n">Filename</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the data from the filename.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">RawData</span><span class="p">(</span><span class="n">_load</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load_background</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="n">BackgroundFilename</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RawBackground</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the background from the filename.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">RawBackground</span><span class="p">(</span><span class="n">_load</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_clean</span><span class="p">(</span><span class="n">raw_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="n">raw_data</span><span class="p">:</span> <span class="n">RawData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CleanedData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean the data, removing NaNs.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CleanedData</span><span class="p">(</span><span class="n">_clean</span><span class="p">(</span><span class="n">raw_data</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">clean_background</span><span class="p">(</span><span class="n">raw_data</span><span class="p">:</span> <span class="n">RawBackground</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CleanedBackground</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean the background, removing NaNs.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CleanedBackground</span><span class="p">(</span><span class="n">_clean</span><span class="p">(</span><span class="n">raw_data</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">subtract_background</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">CleanedData</span><span class="p">,</span> <span class="n">background</span><span class="p">:</span> <span class="n">CleanedBackground</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackgroundSubtractedData</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">BackgroundSubtractedData</span><span class="p">([</span><span class="n">x</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">BackgroundSubtractedData</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">ScaleFactor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process the data, multiplying the sum by the scale factor.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">param</span><span class="p">)</span>


<span class="c1"># 3. Create pipeline</span>

<span class="n">providers</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">load</span><span class="p">,</span>
    <span class="n">load_background</span><span class="p">,</span>
    <span class="n">clean</span><span class="p">,</span>
    <span class="n">clean_background</span><span class="p">,</span>
    <span class="n">process</span><span class="p">,</span>
    <span class="n">subtract_background</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ScaleFactor</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">Filename</span><span class="p">:</span> <span class="s1">&#39;file102.txt&#39;</span><span class="p">,</span>
    <span class="n">BackgroundFilename</span><span class="p">:</span> <span class="s1">&#39;background.txt&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">sciline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Result=</span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">Result</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">Result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Result=10.8
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/user-guide_generic-providers_3_1.svg" src="../_images/user-guide_generic-providers_3_1.svg" />
</div>
</div>
<p>We would like to reuse the <code class="docutils literal notranslate"><span class="pre">load</span></code> and <code class="docutils literal notranslate"><span class="pre">clean</span></code> functions for the background, without having to add wrappers and without duplicating all the involved domain types (<code class="docutils literal notranslate"><span class="pre">BackgroundFilename</span></code>, <code class="docutils literal notranslate"><span class="pre">RawBackgroundRaw</span></code>, and <code class="docutils literal notranslate"><span class="pre">CleanedBackground</span></code>). However, we cannot do this directly, since <code class="docutils literal notranslate"><span class="pre">Filename</span></code>, <code class="docutils literal notranslate"><span class="pre">RawData</span></code>, and <code class="docutils literal notranslate"><span class="pre">CleanedData</span></code> are unique identifiers specific to the non-background files and the uniqueness forms the foundation of how Sciline works.</p>
<p>Sciline seeks to address this conundrum by providing a mechanism for using <em>generic providers</em> and for defining generic type aliases, introduced in the next section.</p>
</section>
<section id="Generic-domain-types-and-providers">
<h2>Generic domain types and providers<a class="headerlink" href="#Generic-domain-types-and-providers" title="Link to this heading">#</a></h2>
<p>To avoid duplicates of domain types and providers, we may instead define generic domain types and generic providers. The example is then written as:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NewType</span><span class="p">,</span> <span class="n">TypeVar</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sciline</span>

<span class="n">_fake_filesytem</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;file102.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;nan&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">],</span>
    <span class="s1">&#39;file103.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
    <span class="s1">&#39;file104.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;file105.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
    <span class="s1">&#39;background.txt&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">}</span>

<span class="c1"># 1. Define domain types</span>

<span class="c1"># 1.a Define concrete RunType values we will use.</span>
<span class="n">Sample</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;Sample&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
<span class="n">Background</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;Background&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

<span class="c1"># 1.b Define generic domain types</span>
<span class="n">RunType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;RunType&#39;</span><span class="p">,</span> <span class="n">Sample</span><span class="p">,</span> <span class="n">Background</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Filename</span><span class="p">(</span><span class="n">sciline</span><span class="o">.</span><span class="n">Scope</span><span class="p">[</span><span class="n">RunType</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span> <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">RawData</span><span class="p">(</span><span class="n">sciline</span><span class="o">.</span><span class="n">Scope</span><span class="p">[</span><span class="n">RunType</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span> <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CleanedData</span><span class="p">(</span><span class="n">sciline</span><span class="o">.</span><span class="n">Scope</span><span class="p">[</span><span class="n">RunType</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span> <span class="o">...</span>


<span class="c1"># 1.c Define normal domain types</span>
<span class="n">ScaleFactor</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;ScaleFactor&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">BackgroundSubtractedData</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;BackgroundSubtractedData&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
<span class="n">Result</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s1">&#39;Result&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>


<span class="c1"># 2. Define providers</span>

<span class="c1"># 2.a Define generic providers</span>


<span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="n">Filename</span><span class="p">[</span><span class="n">RunType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RawData</span><span class="p">[</span><span class="n">RunType</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the data from the filename.&quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">_fake_filesytem</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">RawData</span><span class="p">[</span><span class="n">RunType</span><span class="p">]({</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">}})</span>


<span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="n">raw_data</span><span class="p">:</span> <span class="n">RawData</span><span class="p">[</span><span class="n">RunType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">CleanedData</span><span class="p">[</span><span class="n">RunType</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean the data, removing NaNs.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

    <span class="k">return</span> <span class="n">CleanedData</span><span class="p">[</span><span class="n">RunType</span><span class="p">]([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span>


<span class="c1"># 2.b Define normal providers</span>
<span class="k">def</span><span class="w"> </span><span class="nf">subtract_background</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">CleanedData</span><span class="p">[</span><span class="n">Sample</span><span class="p">],</span> <span class="n">background</span><span class="p">:</span> <span class="n">CleanedData</span><span class="p">[</span><span class="n">Background</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BackgroundSubtractedData</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">BackgroundSubtractedData</span><span class="p">([</span><span class="n">x</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">BackgroundSubtractedData</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="n">ScaleFactor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Result</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process the data, multiplying the sum by the scale factor.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Result</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="n">param</span><span class="p">)</span>


<span class="c1"># 3. Create pipeline</span>

<span class="n">providers</span> <span class="o">=</span> <span class="p">[</span><span class="n">load</span><span class="p">,</span> <span class="n">clean</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ScaleFactor</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">Filename</span><span class="p">[</span><span class="n">Sample</span><span class="p">]:</span> <span class="s1">&#39;file102.txt&#39;</span><span class="p">,</span>
    <span class="n">Filename</span><span class="p">[</span><span class="n">Background</span><span class="p">]:</span> <span class="s1">&#39;background.txt&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">sciline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Apart from updated type annotations for <code class="docutils literal notranslate"><span class="pre">load</span></code> and <code class="docutils literal notranslate"><span class="pre">clean</span></code>, the code is nearly identical to the original example without background subtraction.</p>
<div class="admonition note">
<p class="admonition-title"><strong>Note</strong></p>
<p>Sciline requires type variables that are used as part of keys to be constrained to a fixed set of types. There are two options for this:</p>
<ul class="simple">
<li><p>Type variable <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.TypeVar">constraints</a>.</p></li>
<li><p>Pipeline constraints.</p></li>
</ul>
<p>Here, we use the first option. See the section on <a class="reference internal" href="#Constraining-type-vars-in-a-pipeline"><span class="std std-ref">Constraining type vars in a pipeline</span></a> for details and the second option.</p>
<p>In the above example, we define a type variable <code class="docutils literal notranslate"><span class="pre">RunType</span></code> that is constrained to be either a <code class="docutils literal notranslate"><span class="pre">Sample</span></code> or a <code class="docutils literal notranslate"><span class="pre">Background</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RunType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;RunType&#39;</span><span class="p">,</span> <span class="n">Sample</span><span class="p">,</span> <span class="n">Background</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title"><strong>Note</strong></p>
<p>We use a peculiar-looking syntax for defining “generic type aliases”. We would love to use <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.NewType">typing.NewType</a> for this, but it does not allow for definition of generic aliases. The syntax we use (subclassing <a class="reference internal" href="../generated/classes/sciline.Scope.html"><span class="doc">sciline.Scope</span></a>) is a workaround for defining generic aliases that work both at runtime and with <a class="reference external" href="https://mypy-lang.org/">mypy</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Filename</span><span class="p">(</span><span class="n">sciline</span><span class="o">.</span><span class="n">Scope</span><span class="p">[</span><span class="n">RunType</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<p>We can get or compute the result as usual:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Result</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Result=</span><span class="si">{</span><span class="n">graph</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Result=10.8
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/user-guide_generic-providers_8_1.svg" src="../_images/user-guide_generic-providers_8_1.svg" />
</div>
</div>
<p>In this case, we could have achieved something similar to the above computation graph using the <a class="reference internal" href="parameter-tables.html"><span class="doc">Parameter Tables</span></a> feature. In the next section we will go through the advantages of using generic providers.</p>
</section>
<section id="Advantages-of-using-generic-providers">
<h2>Advantages of using generic providers<a class="headerlink" href="#Advantages-of-using-generic-providers" title="Link to this heading">#</a></h2>
<section id="Computing-intermediate-results">
<h3>Computing intermediate results<a class="headerlink" href="#Computing-intermediate-results" title="Link to this heading">#</a></h3>
<p>Generic domain types with named scopes make it simple to request computation of intermediate results with a clear notation:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">CleanedData</span><span class="p">[</span><span class="n">Sample</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1, 2, 3]
</pre></div></div>
</div>
</section>
<section id="Specialized-providers">
<h3>Specialized providers<a class="headerlink" href="#Specialized-providers" title="Link to this heading">#</a></h3>
<p>We may wish to specialize a provider for specific values of a generic’s type parameters. For example, we may need to use distinct cleaning functions for <code class="docutils literal notranslate"><span class="pre">Sample</span></code> and <code class="docutils literal notranslate"><span class="pre">Background</span></code>. We can do so simply by defining a specialized provider for each type:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clean_data</span><span class="p">(</span><span class="n">raw_data</span><span class="p">:</span> <span class="n">RawData</span><span class="p">[</span><span class="n">Sample</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">CleanedData</span><span class="p">[</span><span class="n">Sample</span><span class="p">]:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

    <span class="k">return</span> <span class="n">CleanedData</span><span class="p">[</span><span class="n">Sample</span><span class="p">]([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">clean_background</span><span class="p">(</span><span class="n">raw_data</span><span class="p">:</span> <span class="n">RawData</span><span class="p">[</span><span class="n">Background</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">CleanedData</span><span class="p">[</span><span class="n">Background</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">CleanedData</span><span class="p">[</span><span class="n">Background</span><span class="p">]([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span>


<span class="n">providers</span> <span class="o">=</span> <span class="p">[</span><span class="n">load</span><span class="p">,</span> <span class="n">clean_data</span><span class="p">,</span> <span class="n">clean_background</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">subtract_background</span><span class="p">]</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">sciline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">Result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/user-guide_generic-providers_12_0.svg" src="../_images/user-guide_generic-providers_12_0.svg" />
</div>
</div>
</section>
<section id="Generic-providers-and-map-operations">
<h3>Generic providers and map operations<a class="headerlink" href="#Generic-providers-and-map-operations" title="Link to this heading">#</a></h3>
<p>As a more complex example of where generic providers are useful, we may add <code class="docutils literal notranslate"><span class="pre">map</span></code> operation, so we can process multiple samples:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">run_ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">102</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">105</span><span class="p">]</span>
<span class="n">filenames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;file</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.txt&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">run_ids</span><span class="p">]</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ScaleFactor</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="n">Filename</span><span class="p">[</span><span class="n">Background</span><span class="p">]:</span> <span class="s1">&#39;background.txt&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">sciline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">providers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="n">Filename</span><span class="p">[</span><span class="n">Sample</span><span class="p">]:</span> <span class="n">filenames</span><span class="p">})</span>

<span class="c1"># We can collect the results into a list for simplicity in this example</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="o">*</span><span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;collected&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;collected&#39;</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<img alt="../_images/user-guide_generic-providers_14_0.svg" src="../_images/user-guide_generic-providers_14_0.svg" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
list[10.8, 18.4, 28.0, 10.8]
</pre></div></div>
</div>
</section>
<section id="Constraining-type-vars-in-a-pipeline">
<h3>Constraining type vars in a pipeline<a class="headerlink" href="#Constraining-type-vars-in-a-pipeline" title="Link to this heading">#</a></h3>
<p>As mentioned above, type variables must be constrained in Sciline. So far, we did this by listing <a class="reference external" href="https://docs.python.org/3/library/typing.html#typing.TypeVar">constraints</a> when defining type variables. Sometimes, however, this is too restrictive because we need to know all possible types that the type variable can take. Pipeline constraints offer an alternative. Instead of constraining the <em>definition</em> of a type variable, we can constrain its <em>usages</em> in a pipeline.</p>
<p>In this example, <code class="docutils literal notranslate"><span class="pre">T</span></code> itself is unconstrained. But all occurrences of <code class="docutils literal notranslate"><span class="pre">T</span></code> in <code class="docutils literal notranslate"><span class="pre">pipeline</span></code> will be constrained to <code class="docutils literal notranslate"><span class="pre">int</span></code> and <code class="docutils literal notranslate"><span class="pre">float</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeVar</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sciline</span>

<span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">duplicate</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A generic provider that can make any list.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>


<span class="n">pipeline</span> <span class="o">=</span> <span class="n">sciline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span>
    <span class="p">[</span><span class="n">duplicate</span><span class="p">],</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="nb">int</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">float</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">},</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">{</span><span class="n">T</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]},</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[1, 1]
[2.0, 2.0]
</pre></div></div>
</div>
<p>This allows us to use different constraints in different pipelines while using the same <code class="docutils literal notranslate"><span class="pre">T</span></code> and <code class="docutils literal notranslate"><span class="pre">duplicate</span></code> in those pipelines.</p>
<p>It is also possible to combine type variable constraints and pipeline constraints. The latter must then be stricter than the former and further limit the allowed types.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="parameter-tables.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Parameter Tables</p>
      </div>
    </a>
    <a class="right-next"
       href="provenance.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Provenance</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025 Scipp contributors.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><!-- This will display the version of the docs -->
Current Sciline version: 25.11.1 (<a href="https://github.com/scipp/sciline/releases">older versions</a>).</div>
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>